<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Mongock Documentation">

    <title>Mongock Documentation</title>

    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" sizes="any" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link href="/styles/base-styles.css" rel="stylesheet" />
    <link href="/styles/content.css" rel="stylesheet" />
    <link href="/styles/layout.css" rel="stylesheet" />
    <link href="/styles/side-menu.css" rel="stylesheet" />
    <link href="/styles/util.css" rel="stylesheet" />
    <link href="/styles/prism-base16-ateliersulphurpool.light.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Fjalla+One|Roboto" rel="stylesheet" />
  </head>

  <body>

    <!-- Header navigation -->
    <header>
  <div class="page-max-width d-flex flex-space-between flex-content-center">
    <div class="d-flex flex-items-center ml-0 mr-auto">
      <a class="logo d-inline-flex flex-items-center" href="https://www.mongock.io">
        <span class="mr-12">Mongock</span>
        <p class="text-left">
          <img src="/images/logo.png" width="15%" alt="Mongock">
        </p>  
       </a>
    </div>

    <nav class="d-flex flex-items-center ml-auto mr-0">
      <a class="mr-24" href="/">
        Home
      </a> 
      <a class="mr-24" href="/v5/professional" style="color: #05a18a;">
        Professional
      </a>
      <a href="https://github.com/mongock/mongock" target="_blank" rel="nofolllow">
        <!-- Source: <https://github.com/encharm/Font-Awesome-SVG-PNG/blob/master/black/svg/github.svg> -->
<svg focusable="false" viewBox="0 0 1792 1792"><title>GitHub</title><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"></path></svg>

        <span class="ml-8">GitHub</span>
      </a>
    </nav>
  </div>
</header>


    <!-- Main page content -->
    <main class="page-max-width">
      




<script>
const versions = [];

 
versions.push({value: "v5", index: "/index.html" });
  
let defaultVersion = "v5";
  

 
versions.push({value: "v4", index: "/v4/index.html" });
  

 
versions.push({value: "v3", index: "/v3/index.html" });
  


const selectedVersions = defaultVersion;
window.onload = function() {
  const urlVersion = window.location.pathname.split("/")[1];
  let validVersion = "";
  versions.forEach(version => {
    if(urlVersion == version.value) {
      validVersion = urlVersion;
    }
  })
  pickVersion(validVersion);
};

function pickVersion(urlVersion) {
  const pickedVersion = urlVersion || defaultVersion;
  document.getElementById("versionSelect").value = pickedVersion;
  versions.forEach(version => {
    const htmlElement = document.getElementById(version.value);
    if(htmlElement) {
      if(pickedVersion == version.value) {
        htmlElement.style.display = "inline";
      } else {
        htmlElement.style.display = "none";
      }
    }
    
  });
}

function changeVersion() {
  var newVersion = document.getElementById("versionSelect").value;
  for(let i = 0 ; i < versions.length ; i++) {
    const version = versions[i];
    if(version.value == newVersion) {
      window.location.href = window.location.origin + version.index;

    } else {
      console.log("version " + newVersion + " not found. Not redirecting.")
    }
  }
}

</script>






<aside class="side-menu">
  
  <select style="width: 100%" name="version" id="versionSelect" onchange="changeVersion()">
    
      <option value="v5">version 5</option>
    
      <option value="v4">version 4</option>
    
      <option value="v3">version 3</option>
    
  </select>
  <br /><br />



  <nav class="menu-root">
    
      <div id="v5" style="display: none;">
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/index.html">
        What is mongock
      </a>
    
  </h7>

          <nav class="What is mongock">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/professional/index.html">
        Professional
      </a>
    
  </h7>

          <nav class="Professional">
            
              
  
  <a class="menu-item "  href="/v5/professional/setup.html">
    Set up
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/technical-overview/index.html">
        Technical overview
      </a>
    
  </h7>

          <nav class="Technical overview">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/get-started/index.html">
        Get started
      </a>
    
  </h7>

          <nav class="Get started">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item current-page"  href="/v5/migration/index.html">
        Migration
      </a>
    
  </h7>

          <nav class="Migration">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/runner/index.html">
        Runner
      </a>
    
  </h7>

          <nav class="Runner">
            
              
  
  <a class="menu-item "  href="/v5/runner/standalone/index.html">
    Runner: Standalone
  </a>

            
              
  
  <a class="menu-item "  href="/v5/runner/springboot/index.html">
    Runner: Springboot
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/driver/index.html">
        Driver
      </a>
    
  </h7>

          <nav class="Driver">
            
              
  
  <a class="menu-item "  href="/v5/driver/mongodb-sync/index.html">
    MongoDB Sync
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/mongodb-springdata/index.html">
    MongoDB Spring data
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/mongodb-reactive/index.html">
    MongoDB reactive
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/cosmosdb/index.html">
    CosmosDB
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/documentdb/index.html">
    DocumentDB
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/couchbase/index.html">
    Couchbase
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/dynamodb/index.html">
    DynamoDB
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      Features
    
  </h7>

          <nav class="Features">
            
              
  
  <a class="menu-item "  href="/v5/features/custom-injections/index.html">
    Custom injections
  </a>

            
              
  
  <a class="menu-item "  href="/v5/features/transactions/index.html">
    Transactions
  </a>

            
              
  
  <a class="menu-item "  href="/v5/features/events/index.html">
    Events
  </a>

            
              
  
  <a class="menu-item "  href="/v5/features/multitenant/index.html">
    Multitenant
  </a>

            
              
  
  <a class="menu-item "  href="/v5/features/legacy-migration/index.html">
    Legacy migration
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/cli/index.html">
        CLI
      </a>
    
  </h7>

          <nav class="CLI">
            
              
  
  <a class="menu-item "  href="/v5/cli/operations/index.html">
    Operations
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/resources/index.html">
        Resources
      </a>
    
  </h7>

          <nav class="Resources">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/testing/index.html">
        Testing
      </a>
    
  </h7>

          <nav class="Testing">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/contributing/index.html">
        Contributing
      </a>
    
  </h7>

          <nav class="Contributing">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/faq/index.html">
        FAQ
      </a>
    
  </h7>

          <nav class="FAQ">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/from-version-4-to-5/index.html">
        From version 4 to 5
      </a>
    
  </h7>

          <nav class="From version 4 to 5">
            
          </nav>
        
      </div>  
    
      <div id="v4" style="display: none;">
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/index.html">
        What is Mongock?
      </a>
    
  </h7>

          <nav class="What is Mongock?">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/main-concepts/index.html">
        Main concepts
      </a>
    
  </h7>

          <nav class="Main concepts">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/quick-start/index.html">
        Quick start
      </a>
    
  </h7>

          <nav class="Quick start">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/changelogs/index.html">
        Changelogs
      </a>
    
  </h7>

          <nav class="Changelogs">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/driver/index.html">
        Driver
      </a>
    
  </h7>

          <nav class="Driver">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/runner/index.html">
        Runner
      </a>
    
  </h7>

          <nav class="Runner">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/compatibility/index.html">
        Compatibility
      </a>
    
  </h7>

          <nav class="Compatibility">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/lock/index.html">
        Lock
      </a>
    
  </h7>

          <nav class="Lock">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/custom-injections/index.html">
        Custom injections
      </a>
    
  </h7>

          <nav class="Custom injections">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/spring-features/index.html">
        Spring features
      </a>
    
  </h7>

          <nav class="Spring features">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/advanced-configuration/index.html">
        Advanced configuration
      </a>
    
  </h7>

          <nav class="Advanced configuration">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/transactions/index.html">
        Transactions
      </a>
    
  </h7>

          <nav class="Transactions">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/reactive/index.html">
        Reactive
      </a>
    
  </h7>

          <nav class="Reactive">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/events/index.html">
        Events
      </a>
    
  </h7>

          <nav class="Events">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/legacy-migration/index.html">
        Legacy migration
      </a>
    
  </h7>

          <nav class="Legacy migration">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/releases/index.html">
        Releases
      </a>
    
  </h7>

          <nav class="Releases">
            
          </nav>
        
      </div>  
    
      <div id="v3" style="display: none;">
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v3/index.html">
        Version3
      </a>
    
  </h7>

          <nav class="Version3">
            
          </nav>
        
      </div>  
    
  </nav>
</aside>

      <article>
        <h1 class="title">Migration</h1>
<!--<ol>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#changeunit-methods">ChangeUnit methods</a></li>
  <li><a href="#changeunit-attributes">ChangeUnit attributes</a></li>
  <li><a href="#changeunit-example">ChangeUnit example</li>
  <li><a href="#best-practices">Best practices</li>
  <li><strike><a href="#changeLog">ChangeLog</a></strike></li>
</ol>-->
<p><div class="table-of-contents"><h2>Table of Contents</h2><ul><li><a href="#introduction"> Introduction</a></li><li><a href="#changeunit-methods"> ChangeUnit methods</a></li><li><a href="#changeunit-attributes"> ChangeUnit attributes</a></li><li><a href="#changeunit-example"> ChangeUnit example</a></li><li><a href="#best-practices"> Best practices</a></li></ul></div></p>
<p class="tip">The <b>@ChangeLog</b> annotation has been <b>deprecated</b> in favour of the <b>@ChangeUnit</b>. For more information check <a href="/v5/faq#why-we-have-added-the-changeunit-annotation-and-deprecated-changelog">this section</a></p>
<h2 id="introduction"><a class="header-anchor" href="#introduction">#</a> Introduction</h2>
<p>A migration is composed by multiple smaller pieces called ChangeUnits, which are processed in order by the Mongock runner.</p>
<p>ChangeUnits are the unit of migration. These refer to the annotated classes where developers write  migration logic/scripts.</p>
<p>All classes with the <code>@ChangeUnit</code> annotation will be scanned by Mongock to execute the migration.</p>
<p>A migration is constituted by an ordered list of ChangeUnits. Each of the ChangeUnits represent a <em>unit of migration</em>, which has the following implications:</p>
<ol>
<li>Each ChangeUnit is wrapped in a <strong>transaction:</strong>.
<ul>
<li>When transactions are possible(transactional environment), Mongock uses the mechanism provided by the database.</li>
<li>On the other hand, in non-transactional environments, Mongock will try to provide an artificial transactional atmosphere by rolling back the failed change manually.</li>
</ul>
</li>
<li>In targeted operations, such as <code>undo</code>, <code>upgrade</code>, etc., the ChangeUnit is the unit of the operation. For example, when performing an <code>undo</code> operation, it needs to specify the <em>ChangeUnitId</em> until which all the ChangeUnits are reverted(inclusive).</li>
<li>A ChangeUnit has only one migration method, which is marked with the <strong>@Execution</strong> annotation, and a rollback method, annotated with <strong>@RollbackExecution</strong>.</li>
</ol>
<hr>
<h2 id="changeunit-methods"><a class="header-anchor" href="#changeunit-methods">#</a> ChangeUnit methods</h2>
<p>Every class marked as <code>@ChangeUnit</code> will be marked as a migration class and can contain methods annotated as follow:</p>
<ul>
<li>
<p><strong>@Execution:</strong> The main migration method(Mandatory).</p>
</li>
<li>
<p><strong>@RollbackExecution:</strong> This method basically reverts the changes made by the <code>@Execution</code> method. It's mandatory and highly recommended to properly implement it. It can be left empty if developers don't think is required in some scenarios.</p>
<p>It will be triggered in the two following situations:</p>
<ul>
<li>When the <code>@Execution</code> method fails in a non-transactional environment.</li>
<li>In recovery operation like <strong>undo</strong>.</li>
</ul>
</li>
<li>
<p><strong>@BeforeExecution:</strong> Optional method that will be executed before the actual migration, meaning this that it won't be part of the transactional and executed in non-transactional context. It's useful to perform DDL operations in database where they are not allowed inside a transaction, like MongoDB, or as preparation for the actual migration.</p>
</li>
</ul>
<p>This method is treated and tracked in the database history like the <code>@Execution</code> method, meaning this that in case of failure, it will force the migration to be aborted, tracked in the database as failed and Mongock will run it again in the next execution.</p>
<ul>
<li><strong>@RollbackBeforeExecution:</strong> Similar to the <code>@RollbackExecution</code> for the <code>@Execution</code> method. It reverts back the changes made by the <code>@BeforeExecution</code> method. It's only mandatory when the method <code>@BeforeExecution</code> is present.</li>
</ul>
<hr>
<h2 id="changeunit-attributes"><a class="header-anchor" href="#changeunit-attributes">#</a> ChangeUnit attributes</h2>
<p>Multiple attributes can be passed to ChangeUnits to configure these. The following table represents the list of attributes that you can set for preparing your migration:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th style="text-align:left">Description</th>
<th style="text-align:center">Mandatory?</th>
<th style="text-align:center">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td style="text-align:left">Returns the ChangeUnit's id that will be stored in the ChangeUnit history table/collection and will the way to identify a ChangeUnit. The combination of this field and the author must be unique among the changeunits.</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">n/a</td>
</tr>
<tr>
<td>order</td>
<td style="text-align:left">Returns the ChangeUnit's execution order. The order will be applied treating the value as alphanumeric.</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">n/a</td>
</tr>
<tr>
<td>author</td>
<td style="text-align:left">Returns the ChangeUnit's author. The combination of this and the author must be unique among the changeunits.</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"><code>default-author</code></td>
</tr>
<tr>
<td>runAlways</td>
<td style="text-align:left">Returns whether the ChangeUnit is runAlways or not. For more information, visit the <a href="/v5/runner/#configuration">runner configuration section</a>.</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"><code>false</code></td>
</tr>
<tr>
<td>systemVersion</td>
<td style="text-align:left">Returns the ChangeUnit's system version. For more information, visit the <a href="/v5/runner/#configuration">runner configuration section</a>.</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"><code>0</code></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="changeunit-example"><a class="header-anchor" href="#changeunit-example">#</a> ChangeUnit example</h2>
<p class="successAlt">ChangeUnits accept dependency injections directly in the method and at constructor level</p>
<p class="tip">The value of <b>@ChangeUnit</b>'s <b>order</b> annotation field will be treated as alphanumeric.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token annotation punctuation">@ChangeUnit</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">"myMigrationChangeUnitId"</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token string">"001"</span><span class="token punctuation">,</span> author <span class="token operator">=</span> <span class="token string">"mongock_test"</span><span class="token punctuation">,</span> systemVersion <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMigrationChangeUnit</span> <span class="token punctuation">{</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MongoTemplate</span> template<span class="token punctuation">;</span></div><div class="highlight-line">  </div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token class-name">MyMigrationChangeUnit</span><span class="token punctuation">(</span><span class="token class-name">MongoTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>template <span class="token operator">=</span> template<span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token comment">//Note this method / annotation is Optional</span></div><div class="highlight-line">  <span class="token annotation punctuation">@BeforeExecution</span></div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">    mongoTemplate<span class="token punctuation">.</span><span class="token function">createCollection</span><span class="token punctuation">(</span><span class="token string">"clients"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token comment">//Note this method / annotation is Optional</span></div><div class="highlight-line">  <span class="token annotation punctuation">@RollbackBeforeExecution</span></div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollbackBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">    mongoTemplate<span class="token punctuation">.</span><span class="token function">dropCollection</span><span class="token punctuation">(</span><span class="token string">"clients"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token annotation punctuation">@Execution</span></div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">migrationMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">    <span class="token function">getClientDocuments</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">      <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>clientDocument <span class="token operator">-></span> mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>clientDocument<span class="token punctuation">,</span> CLIENTS_COLLECTION_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token annotation punctuation">@RollbackExecution</span></div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">        mongoTemplate<span class="token punctuation">.</span><span class="token function">deleteMany</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<hr>
<h2 id="best-practices"><a class="header-anchor" href="#best-practices">#</a> Best practices</h2>
<ul>
<li>
<p><strong>Use the Operation classes in favour of persisted objects in your ChangeUnits</strong>
Although Mongock provides a powerful mechanism that allows you to inject any dependency you wish to your ChangeUnits, these are considered the source of truth and should treated like static resources, once executed shouldn't be changed.</p>
<p>With this in mind, imagine the scenario you have the class <code>Client</code> that represents a table in your database. You create a ChangeUnit which uses the field <code>name</code> of the client. One month later, you realise the field is not needed anymore and decide to remove it. If you remove it, the first ChangeUnit's code won't compile. This leaves you with two options: either remove/update the first ChangeUnit or keep the unneeded field <code>name</code>. Neither of which is a good option.</p>
<p>An example for MongoDB would be to use MongoTemplate in favour of using Repository classes directly to perform the migrations.</p>
</li>
<li>
<p><strong>High Availability Considerations:</strong>
In a distributed environment where multiple nodes of the application are running, there are a few considerations when building migrations  with Mongock:</p>
<ul>
<li>
<p><strong>Backwards compatible ChangeUnits</strong>
While the migration process is taking place, the old version of the software is likely to still be running. During this time, it can happen that the old version of the software is dealing with the new version of the data. Scenarios where the data is a mix between old and new versions could also occur. This means the software must still work regardless of the status of the database. It can be a detriment to High Availability if ChangeUnits are  non-backward-compatible ChangeUnits.</p>
</li>
<li>
<p><strong>2-stage approach</strong>
There are certain update operations that can leave code and data in an inconsistent state whilst performing a change. In such scenarios, we recommend to perform the change in two independent deployments.
The first one: only provides additions and is compatible with the current deployed code. At this stage, the code would work with the old structure as well as the next change that will be applied. At this point, if the migration was executed, it affects the database but not the code allowing services to be running because the migration didn't produce a breaking change.
The next step is required to ensure the new refactored code is also deployed. Once this is done, we have the first part of the data migration done(we only have to remove what's not needed anymore) and the code is able to work with the actual version of the data and the next migration that will be applying.
The last stage is to do the new deployment with the data migration(which is compatible with the current code deployed) together with the code reflecting the change. Once again, there are chances that the data migration is done but the service itself(code) doesn't. This is not a problem as the code deployed is also compatible with the new version of the data.</p>
</li>
</ul>
</li>
<li>
<p><strong>Light ChangeUnits</strong>
Try to wrap your migration in relatively light ChangeUnits. The concept of light is not universal, but the time to execute a ChangeUnit shouldn't mean a risk to the application's startup.</p>
<p>For example, when using Kubernetes in a transactional environment, if a ChangeUnit can potentially take longer than the Kubernetes initial delay, the services will proably fall into a infinite loop. If there is no ChangeUnit that puts this in risk, the worse case scenario is that the service will be re-started by the Kubernetes agents as it needs more time to acomplish the entire migration, but eventually the migration will finalise.</p>
</li>
<li>
<p><strong>Try to enforce idempotency in your ChangeUnits</strong> (for non-transactional environment).
In these cases, a ChangeUnit can be interrupted at any time. Mongock will execute again in the next execution. Although you have the rollback feature, in non-transactional environments it's not guaranteed that it's executed correctly.</p>
</li>
<li>
<p><strong>ChangeUnit reduces its execution time in every iteration</strong> (for non-transactional environment).
A ChangeUnit can be interrupted at any time. This means an specific ChangeUnit needs to be re-run. In the undesired scenario where the ChangeUnit's execution time is greater than the interruption time(could be Kubernetes initial delay), that ChangeUnit won't be ever finished. So the ChangeUnit needs to be developed in such a way that every iteration reduces its execution time, so eventually, after some iterations, the ChangeUnit finished.</p>
</li>
</ul>
<hr>
<h2 id="changeLog"><strike>ChangeLog</strike></h2>
<p>From Mongock version 5, <code>@ChangeLog</code> and <code>@ChangeSet</code> annotations are <strong>deprecated</strong> and shouldn't be used. However, these  won't be removed for backwards compatibility.</p>
<div class="success">Please follow one of the recommended approaches depending on your use case:
<p>- <b>For existing changeLogs created prior version 5:</b> Leave it untouched, keeping the deprecated annotation.</p>
<p>- <b>For new migrations from version 5:</b> Use the new @ChangeUnit annotation instead.</p>
</div>
<br />
<p>Please visit the <a href="/v4/changelogs/index.html">ChangeLog - version 4</a> section to access the ChangeLog documentation for Version 4.</p>
<p>For more information about the reason we have adopted this change, please visit our <a href="/v5/faq#changelog-deprecation">FAQ section</a>.</p>

      </article>
    </main>

    <!-- Footer -->
    <footer>
  <nav class="page-max-width d-flex flex-space-evenly flex-items-center">
    <a class="d-inline-flex flex-center flex-items-center" href="https://www.mongock.io">Mongock</a>
    <div class="d-flex flex-center flex-items-center">
      <a class="d-inline-flex flex-items-center mr-16" href="https://github.com/mongock/mongock" target="_blank" rel="nofollow">
        <!-- Source: <https://github.com/encharm/Font-Awesome-SVG-PNG/blob/master/black/svg/github.svg> -->
<svg focusable="false" viewBox="0 0 1792 1792"><title>GitHub</title><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"></path></svg>

      </a>
      <a class="d-inline-flex flex-items-center" href="https://twitter.com/MongockTeam" target="_blank" rel="nofollow">
        <!-- Source: <https://github.com/encharm/Font-Awesome-SVG-PNG/blob/master/black/svg/twitter.svg> -->
<svg focusable="false" viewBox="0 0 1792 1792"><title>Twitter</title><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path></svg>

      </a>
    </div>
    <a class="d-inline-flex flex-center flex-items-center" href="https://github.com/mongock/mongock/issues" target="_blank" rel="nofollow">
      <!-- Source: <https://octicons.github.com/icon/issue-opened/> -->
<svg viewBox="0 0 14 16" version="1.1" width="112" aria-hidden="true"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>

      <span class="ml-8">Issues</span>
    </a>
  </nav>
</footer>


  </body>
</html>
