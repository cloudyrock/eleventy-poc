<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Mongock Documentation">

    <title>Mongock Documentation</title>

    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" sizes="any" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link href="/styles/base-styles.css" rel="stylesheet" />
    <link href="/styles/content.css" rel="stylesheet" />
    <link href="/styles/layout.css" rel="stylesheet" />
    <link href="/styles/side-menu.css" rel="stylesheet" />
    <link href="/styles/util.css" rel="stylesheet" />
    <link href="/styles/prism-base16-ateliersulphurpool.light.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Fjalla+One|Roboto" rel="stylesheet" />
  </head>

  <body>

    <!-- Header navigation -->
    <header>
  <div class="page-max-width d-flex flex-space-between flex-content-center">
    <div class="d-flex flex-items-center ml-0 mr-auto">
      <a class="logo d-inline-flex flex-items-center" href="https://www.mongock.io">
        <span class="mr-12">Mongock</span>
        <p class="text-left">
          <img src="/images/logo.png" width="15%" alt="Mongock">
        </p>  
       </a>
    </div>

    <nav class="d-flex flex-items-center ml-auto mr-0">
      <a class="mr-24" href="/">
        Home
      </a> 
      <a class="mr-24" href="/v5/professional" style="color: #05a18a;">
        Professional
      </a>
      <a href="https://github.com/mongock/mongock" target="_blank" rel="nofolllow">
        <!-- Source: <https://github.com/encharm/Font-Awesome-SVG-PNG/blob/master/black/svg/github.svg> -->
<svg focusable="false" viewBox="0 0 1792 1792"><title>GitHub</title><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"></path></svg>

        <span class="ml-8">GitHub</span>
      </a>
    </nav>
  </div>
</header>


    <!-- Main page content -->
    <main class="page-max-width">
      




<script>
const versions = [];

 
versions.push({value: "v5", index: "/index.html" });
  
let defaultVersion = "v5";
  

 
versions.push({value: "v4", index: "/v4/index.html" });
  

 
versions.push({value: "v3", index: "/v3/index.html" });
  


const selectedVersions = defaultVersion;
window.onload = function() {
  const urlVersion = window.location.pathname.split("/")[1];
  let validVersion = "";
  versions.forEach(version => {
    if(urlVersion == version.value) {
      validVersion = urlVersion;
    }
  })
  pickVersion(validVersion);
};

function pickVersion(urlVersion) {
  const pickedVersion = urlVersion || defaultVersion;
  document.getElementById("versionSelect").value = pickedVersion;
  versions.forEach(version => {
    const htmlElement = document.getElementById(version.value);
    if(htmlElement) {
      if(pickedVersion == version.value) {
        htmlElement.style.display = "inline";
      } else {
        htmlElement.style.display = "none";
      }
    }
    
  });
}

function changeVersion() {
  var newVersion = document.getElementById("versionSelect").value;
  for(let i = 0 ; i < versions.length ; i++) {
    const version = versions[i];
    if(version.value == newVersion) {
      window.location.href = window.location.origin + version.index;

    } else {
      console.log("version " + newVersion + " not found. Not redirecting.")
    }
  }
}

</script>






<aside class="side-menu">
  
  <select style="width: 100%" name="version" id="versionSelect" onchange="changeVersion()">
    
      <option value="v5">version 5</option>
    
      <option value="v4">version 4</option>
    
      <option value="v3">version 3</option>
    
  </select>
  <br /><br />



  <nav class="menu-root">
    
      <div id="v5" style="display: none;">
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/index.html">
        What is mongock
      </a>
    
  </h7>

          <nav class="What is mongock">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/technical-overview/index.html">
        Technical overview
      </a>
    
  </h7>

          <nav class="Technical overview">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/get-started/index.html">
        Get started
      </a>
    
  </h7>

          <nav class="Get started">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/migration/index.html">
        Migration
      </a>
    
  </h7>

          <nav class="Migration">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/runner/index.html">
        Runner
      </a>
    
  </h7>

          <nav class="Runner">
            
              
  
  <a class="menu-item "  href="/v5/runner/standalone/index.html">
    Runner: Standalone
  </a>

            
              
  
  <a class="menu-item "  href="/v5/runner/springboot/index.html">
    Runner: Springboot
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/driver/index.html">
        Driver
      </a>
    
  </h7>

          <nav class="Driver">
            
              
  
  <a class="menu-item "  href="/v5/driver/mongodb-sync/index.html">
    MongoDB Sync
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/mongodb-springdata/index.html">
    MongoDB Spring data
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/mongodb-reactive/index.html">
    MongoDB reactive
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/cosmosdb/index.html">
    CosmosDB
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/documentdb/index.html">
    DocumentDB
  </a>

            
              
  
  <a class="menu-item "  href="/v5/driver/dynamodb/index.html">
    DynamoDB
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      Features
    
  </h7>

          <nav class="Features">
            
              
  
  <a class="menu-item "  href="/v5/features/transactions/index.html">
    Transactions
  </a>

            
              
  
  <a class="menu-item "  href="/v5/features/events/index.html">
    Events
  </a>

            
              
  
  <a class="menu-item "  href="/v5/features/legacy-migration/index.html">
    Legacy migration
  </a>

            
              
  
  <a class="menu-item current-page"  href="/v5/features/custom-injections/index.html">
    Custom injections
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/cli/index.html">
        CLI
      </a>
    
  </h7>

          <nav class="CLI">
            
              
  
  <a class="menu-item "  href="/v5/cli/operations/index.html">
    Operations
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/resources/index.html">
        Resources
      </a>
    
  </h7>

          <nav class="Resources">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/testing/index.html">
        Testing
      </a>
    
  </h7>

          <nav class="Testing">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/professional/index.html">
        Professional
      </a>
    
  </h7>

          <nav class="Professional">
            
              
  
  <a class="menu-item "  href="/v5/professional/setup.html">
    Set up
  </a>

            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/contributing/index.html">
        Contributing
      </a>
    
  </h7>

          <nav class="Contributing">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/faq/index.html">
        FAQ
      </a>
    
  </h7>

          <nav class="FAQ">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v5/from-version-4-to-5/index.html">
        From version 4 to 5
      </a>
    
  </h7>

          <nav class="From version 4 to 5">
            
          </nav>
        
      </div>  
    
      <div id="v4" style="display: none;">
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/index.html">
        What is Mongock?
      </a>
    
  </h7>

          <nav class="What is Mongock?">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/main-concepts/index.html">
        Main concepts
      </a>
    
  </h7>

          <nav class="Main concepts">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/quick-start/index.html">
        Quick start
      </a>
    
  </h7>

          <nav class="Quick start">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/changelogs/index.html">
        Changelogs
      </a>
    
  </h7>

          <nav class="Changelogs">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/driver/index.html">
        Driver
      </a>
    
  </h7>

          <nav class="Driver">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/runner/index.html">
        Runner
      </a>
    
  </h7>

          <nav class="Runner">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/compatibility/index.html">
        Compatibility
      </a>
    
  </h7>

          <nav class="Compatibility">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/lock/index.html">
        Lock
      </a>
    
  </h7>

          <nav class="Lock">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/custom-injections/index.html">
        Custom injections
      </a>
    
  </h7>

          <nav class="Custom injections">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/spring-features/index.html">
        Spring features
      </a>
    
  </h7>

          <nav class="Spring features">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/advanced-configuration/index.html">
        Advanced configuration
      </a>
    
  </h7>

          <nav class="Advanced configuration">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/transactions/index.html">
        Transactions
      </a>
    
  </h7>

          <nav class="Transactions">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/reactive/index.html">
        Reactive
      </a>
    
  </h7>

          <nav class="Reactive">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/events/index.html">
        Events
      </a>
    
  </h7>

          <nav class="Events">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/legacy-migration/index.html">
        Legacy migration
      </a>
    
  </h7>

          <nav class="Legacy migration">
            
          </nav>
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v4/releases/index.html">
        Releases
      </a>
    
  </h7>

          <nav class="Releases">
            
          </nav>
        
      </div>  
    
      <div id="v3" style="display: none;">
         
          
  
  <h7 class="menu-item">
    
      <a class="menu-item "  href="/v3/index.html">
        Version3
      </a>
    
  </h7>

          <nav class="Version3">
            
          </nav>
        
      </div>  
    
  </nav>
</aside>

      <article>
        <h1 class="title">Custom injections</h1>
<p><div class="table-of-contents"><h2>Table of Contents</h2><ul><li><a href="#introduction"> Introduction</a></li><li><a href="#how-to-use-a-custom-bean-in-changeunit"> How to use a custom bean in changeUnit</a><ul><li><a href="#in-a-constructor"> In a constructor</a></li><li><a href="#in-the-methods"> In the methods</a></li></ul></li><li><a href="#how-to-define%2Finject-your-custom-beans"> How to define/inject your custom beans</a><ul><li><a href="#with-spring-runner"> With Spring runner</a></li><li><a href="#with-standalone-runner"> With Standalone runner</a><ul><li><a href="#just-the-instance%2C-inferring-the-type"> Just the instance, inferring the type</a></li><li><a href="#specifying-the-type"> Specifying the type</a></li><li><a href="#with-name"> With name</a></li><li><a href="#with-name-and-type"> With name and type</a></li></ul></li></ul></li><li><a href="#advanced%3A-proxy-explanation"> Advanced: Proxy explanation</a><ul><li><a href="#relaxing-the-lock%3A-%40nonlockguarded"> Relaxing the lock: @NonLockGuarded</a><ul><li><a href="#return"> RETURN</a></li><li><a href="#method"> METHOD</a></li><li><a href="#none"> NONE</a></li></ul></li><li><a href="#where-can-i-apply-%40nonlockguarded%3F"> Where can I apply @NonLockGuarded?</a><ul><li><a href="#in-a-changeunit-parameter"> In a ChangeUnit parameter</a></li><li><a href="#in-the-bean's-type"> In the bean's type</a></li><li><a href="#in-bean's-method"> In bean's method</a></li></ul></li></ul></li></ul></div></p>
<h1 id="introduction"><a class="header-anchor" href="#introduction">#</a> Introduction</h1>
<p>Mongock primarily uses a code-first approach(<a href="/v5/faq/index.html#why-does-mongock-use-a-code-first-approach-for-its-change-units%3F">here</a> we explain why)
for its migration and one of the benefits is the ability to inject any bean you want to your migration.</p>
<p>Some scenarios this can be useful:</p>
<ul>
<li>When, as part of your migration, you need to retrieve some data from a 3rd party system</li>
<li>When using Spring data, you want to take advantage of your repositories</li>
<li>When you want to perform some operation as part of your migration(lets say, send a notification), and you want the transaction to abort if the operation fails</li>
<li>...</li>
</ul>
<h1 id="how-to-use-a-custom-bean-in-changeunit"><a class="header-anchor" href="#how-to-use-a-custom-bean-in-changeunit">#</a> How to use a custom bean in changeUnit</h1>
<p>There are two ways you can injet your custom injections to a Mongock changeUnit.</p>
<h2 id="in-a-constructor"><a class="header-anchor" href="#in-a-constructor">#</a> In a constructor</h2>
<pre class="language-java"><code class="language-java"><div class="highlight-line"></div><div class="highlight-line"><span class="token annotation punctuation">@ChangeUnit</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">"client-initializer"</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">,</span> author <span class="token operator">=</span> <span class="token string">"mongock"</span><span class="token punctuation">)</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientInitializerChange</span> <span class="token punctuation">{</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThirPartyService</span> thirdPartyService<span class="token punctuation">;</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token class-name">ClientInitializerChange</span><span class="token punctuation">(</span><span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">,</span> <span class="token class-name">ThirPartyService</span> thirdPartyService<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate <span class="token operator">=</span> mongoTemplate<span class="token punctuation">;</span></div><div class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>thirdPartyService <span class="token operator">=</span> thirdPartyService<span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"></div><div class="highlight-line"><span class="token comment">//...Methods @Execution, @RollbackExecution, etc.</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h2 id="in-the-methods"><a class="header-anchor" href="#in-the-methods">#</a> In the methods</h2>
<pre class="language-java"><code class="language-java"><div class="highlight-line"></div><div class="highlight-line"><span class="token annotation punctuation">@ChangeUnit</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">"client-initializer"</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">,</span> author <span class="token operator">=</span> <span class="token string">"mongock"</span><span class="token punctuation">)</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientInitializerChange</span> <span class="token punctuation">{</span></div><div class="highlight-line"></div><div class="highlight-line">  <span class="token annotation punctuation">@Execution</span></div><div class="highlight-line">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeSet</span><span class="token punctuation">(</span><span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">,</span> <span class="token class-name">ThirPartyService</span> thirdPartyService<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">    thirdPartyService<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>client <span class="token operator">-></span> mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> CLIENTS_COLLECTION_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><div class="highlight-line">  <span class="token punctuation">}</span></div><div class="highlight-line"></div><div class="highlight-line"><span class="token comment">//...Methods @RollbackExecution, etc.</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h1 id="how-to-define%2Finject-your-custom-beans"><a class="header-anchor" href="#how-to-define%2Finject-your-custom-beans">#</a> How to define/inject your custom beans</h1>
<h2 id="with-spring-runner"><a class="header-anchor" href="#with-spring-runner">#</a> With Spring runner</h2>
<p>If you are using Spring Runner, you will be able to access to all the beans present in the Spring context,
just by adding the required bean in your changeSet as parameter.</p>
<h2 id="with-standalone-runner"><a class="header-anchor" href="#with-standalone-runner">#</a> With Standalone runner</h2>
<p>While you will still be using your custom bean by adding the parameter in your changeSet method as parameter,
as the previous figure, when using the standalone runner you need to inject your custom bean manually at building time.</p>
<p>You have 4 ways to add your bean(or dependency):</p>
<h3 id="just-the-instance%2C-inferring-the-type"><a class="header-anchor" href="#just-the-instance%2C-inferring-the-type">#</a> Just the instance, inferring the type</h3>
<p>Mongock will extract the type from the instance.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token class-name">MongockStandalone</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token comment">//..        </span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>youBean<span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">buildRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></code></pre>
<h3 id="specifying-the-type"><a class="header-anchor" href="#specifying-the-type">#</a> Specifying the type</h3>
<p>The issue with the previous approach is, for example, when your bean implements an interface and you want your bean to be injected when any changeSet specify the interface as a parameter</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token class-name">MongockStandalone</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token comment">//..        </span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>yourBeanInterface<span class="token punctuation">,</span> youBean<span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">buildRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></code></pre>
<h3 id="with-name"><a class="header-anchor" href="#with-name">#</a> With name</h3>
<p>Sometimes, regardless of the type, you want the bean to be injected by a name.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token class-name">MongockStandalone</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token comment">//..        </span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span><span class="token string">"myBean"</span><span class="token punctuation">,</span> youBean<span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">buildRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></code></pre>
<h3 id="with-name-and-type"><a class="header-anchor" href="#with-name-and-type">#</a> With name and type</h3>
<p>And there may be other times when you want everything, be able to reference your bean in your changeSets with a name and by type.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token class-name">MongockStandalone</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token comment">//..        </span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span><span class="token string">"myBean"</span><span class="token punctuation">,</span> yourBeanInterface<span class="token punctuation">,</span> youBean<span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">buildRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><div class="highlight-line">        <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></code></pre>
<h1 id="advanced%3A-proxy-explanation"><a class="header-anchor" href="#advanced%3A-proxy-explanation">#</a> Advanced: Proxy explanation</h1>
<p>Mongock, as part of its lock mechanism, uses proxies to synchronize all the operations executed in a changeUnit and ensure they are securely executed.
This means, by default, all the beans injected in a changeUnit are proxied.</p>
<p>As part of the Mongock's lock mechanism, by default, all the dependencies injected to a changeUnit are proxied to ensure
the database is accessed in a  synchronised manner.</p>
<p>The Mongock's proxy instrumentation have two main goals:</p>
<ol>
<li>Intercept the actual method you are calling to ensure the lock is acquired.</li>
<li>Return a proxied object  to ensure the lock is acquired in subsequent calls
<br><br></li>
</ol>
<div class="tipAlt">
By default, Mongock won't return a proxied object if one of the following conditions is in place:  The returned object is a primitive type, String, Class type, wrapper type or any object in a package prefixed by"java.", "com.sun.", "javax.", "jdk.internal." or "sun."
</div>
<br><br>
<h2 id="relaxing-the-lock%3A-%40nonlockguarded"><a class="header-anchor" href="#relaxing-the-lock%3A-%40nonlockguarded">#</a> Relaxing the lock: @NonLockGuarded</h2>
<p>Although it is a conservative approach, the default Mongock's proxy behaviour it's the recommended option and most cases will be fine with it.
It is a convenient way which provides a good balance between easiness and performance.</p>
<p>However, sometimes you need a tune this. Luckily in Mongock almost everything is configurable and something as sensitive as a proxy won't be an exception.</p>
<p>You can tell Mongock to relax the application of the lock on a given bean, class or method with the annotation @NonLockGuarded.</p>
<p>There are 3 levels this annotation can be applied</p>
<h3 id="return"><a class="header-anchor" href="#return">#</a> RETURN</h3>
<p>It means that all the repository's methods are protected by the lock, but the  objects returned(in this case RevampDocument)
by all its method are clean(no proxies)</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token annotation punctuation">@Execution</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execution</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonLockGuarded</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span> <span class="token class-name">RevampRepository</span> revampRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">  <span class="token comment">//TODO</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h3 id="method"><a class="header-anchor" href="#method">#</a> METHOD</h3>
<p>It's the opposite to <strong>RETURN</strong>, Indicates the method's bean shouldn't be lock-guarded, but still should the returned object should be a proxy.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token annotation punctuation">@Execution</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execution</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonLockGuarded</span><span class="token punctuation">(</span>METHOD<span class="token punctuation">)</span> <span class="token class-name">RevampRepository</span> revampRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">  <span class="token comment">//TODO</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h3 id="none"><a class="header-anchor" href="#none">#</a> NONE</h3>
<p>Indicates the method shouldn't be lock-guarded neither the returned object should be decorated for lock guard.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token annotation punctuation">@Execution</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execution</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonLockGuarded</span><span class="token punctuation">(</span>NONE<span class="token punctuation">)</span> <span class="token class-name">RevampRepository</span> revampRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">  <span class="token comment">//TODO</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h2 id="where-can-i-apply-%40nonlockguarded%3F"><a class="header-anchor" href="#where-can-i-apply-%40nonlockguarded%3F">#</a> Where can I apply @NonLockGuarded?</h2>
<h3 id="in-a-changeunit-parameter"><a class="header-anchor" href="#in-a-changeunit-parameter">#</a> In a ChangeUnit parameter</h3>
<p>This will tell Mongock you don't want to proxy that bean in that specific changeUnit method.</p>
<p>This is useful when, in general you are fine proxing the bean, but there are some exceptions or when you don't want to use the annotation in your type, so you annotate all your custom bean parameters in all your changeSet methods.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token annotation punctuation">@ChangeLog</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientInitializerChangeLog</span> <span class="token punctuation">{</span></div><div class="highlight-line"></div><div class="highlight-line">    <span class="token annotation punctuation">@ChangeSet</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">"data-initializer-with-repository"</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token string">"001"</span><span class="token punctuation">,</span> author <span class="token operator">=</span> <span class="token string">"mongock"</span><span class="token punctuation">)</span></div><div class="highlight-line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dataInitializer</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonLockGuarded</span> <span class="token class-name">ClientRepository</span> clientRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">        <span class="token comment">//...</span></div><div class="highlight-line">    <span class="token punctuation">}</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h3 id="in-the-bean's-type"><a class="header-anchor" href="#in-the-bean's-type">#</a> In the bean's type</h3>
<p>If you annotate your custom bean's type, Mongock won't never proxy any bean of that type.</p>
<p>It's obviously useful when you know that type won't be accessing to database at all or you don't want to proxy any parameter of that type, for any other reason.</p>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token annotation punctuation">@NonLockGuarded</span></div><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCustomBeanImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MyCustomBean</span> <span class="token punctuation">{</span></div><div class="highlight-line">    <span class="token comment">//...</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>
<h3 id="in-bean's-method"><a class="header-anchor" href="#in-bean's-method">#</a> In bean's method</h3>
<pre class="language-java"><code class="language-java"><div class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCustomBeanImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MyCustomBean</span> <span class="token punctuation">{</span></div><div class="highlight-line">    </div><div class="highlight-line">    <span class="token annotation punctuation">@NonLockGuarded</span></div><div class="highlight-line">    <span class="token keyword">public</span> <span class="token class-name">MyCustomBean</span> <span class="token function">accessToDatabaseAndReturnProxiableObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><div class="highlight-line">        <span class="token comment">//...</span></div><div class="highlight-line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyCustomBeanImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><div class="highlight-line">    <span class="token punctuation">}</span></div><div class="highlight-line"><span class="token punctuation">}</span></div></code></pre>

      </article>
    </main>

    <!-- Footer -->
    <footer>
  <nav class="page-max-width d-flex flex-space-evenly flex-items-center">
    <a class="d-inline-flex flex-center flex-items-center" href="https://www.mongock.io">Mongock</a>
    <div class="d-flex flex-center flex-items-center">
      <a class="d-inline-flex flex-items-center mr-16" href="https://github.com/mongock/mongock" target="_blank" rel="nofollow">
        <!-- Source: <https://github.com/encharm/Font-Awesome-SVG-PNG/blob/master/black/svg/github.svg> -->
<svg focusable="false" viewBox="0 0 1792 1792"><title>GitHub</title><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"></path></svg>

      </a>
      <a class="d-inline-flex flex-items-center" href="https://twitter.com/MongockTeam" target="_blank" rel="nofollow">
        <!-- Source: <https://github.com/encharm/Font-Awesome-SVG-PNG/blob/master/black/svg/twitter.svg> -->
<svg focusable="false" viewBox="0 0 1792 1792"><title>Twitter</title><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path></svg>

      </a>
    </div>
    <a class="d-inline-flex flex-center flex-items-center" href="https://github.com/mongock/mongock/issues" target="_blank" rel="nofollow">
      <!-- Source: <https://octicons.github.com/icon/issue-opened/> -->
<svg viewBox="0 0 14 16" version="1.1" width="112" aria-hidden="true"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>

      <span class="ml-8">Issues</span>
    </a>
  </nav>
</footer>


  </body>
</html>
